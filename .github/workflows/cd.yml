name: Deploy (Production) via SSH

# 1. Configura o gatilho para rodar sempre que houver um push para o branch 'main'
on:
  push:
    branches:
      - main
  workflow_dispatch: # Permite acionamento manual no GitHub

# Define as vari√°veis de ambiente base para uso interno no workflow
env:
  PROJECT_PATH: /root/Avalia-Solar-2026

jobs:
  deploy:
    # Usa o Runner padr√£o do GitHub
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout C√≥digo
        uses: actions/checkout@v4

      # ‚öôÔ∏è 1. Configurar Vari√°veis de Ambiente no Droplet
      - name: Injetar Segredos e Chaves no Arquivo .env
        uses: appleboy/ssh-action@v1.0.3
        with:
          # Segredos de Conex√£o SSH
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          
          # Script para criar o arquivo .env no servidor
          script: |
            echo "--- Configurando .env no servidor ---"
            cd ${{ env.PROJECT_PATH }}
            
            # Limpa o arquivo .env para reescrita
            > .env 
            
            # Escreve as vari√°veis de ambiente no formato Shell (ENV=VALOR)
            printf "RAILS_ENV=production\n" >> .env
            printf "PORT=3001\n" >> .env
            printf "RAILS_LOG_TO_STDOUT=true\n" >> .env
            printf "RAILS_SERVE_STATIC_FILES=true\n" >> .env
            
            # Vari√°veis de Seguran√ßa
            printf "RAILS_MASTER_KEY=%s\n" "${{ secrets.RAILS_MASTER_KEY }}" >> .env
            printf "SECRET_KEY_BASE=%s\n" "${{ secrets.SECRET_KEY_BASE }}" >> .env
            printf "JWT_SECRET=%s\n" "${{ secrets.JWT_SECRET }}" >> .env
            
            # Vari√°veis do Postgres
            printf "POSTGRES_USER=%s\n" "${{ secrets.POSTGRES_USER }}" >> .env
            printf "POSTGRES_PASSWORD=%s\n" "${{ secrets.POSTGRES_PASSWORD }}" >> .env
            printf "POSTGRES_DB=%s\n" "${{ secrets.POSTGRES_DB }}" >> .env
            
            # DATABASE_URL
            printf "DATABASE_URL=postgresql://%s:%s@db:5432/%s\n" \
                "${{ secrets.POSTGRES_USER }}" \
                "${{ secrets.POSTGRES_PASSWORD }}" \
                "${{ secrets.POSTGRES_DB }}" >> .env
            
            # Outras Vari√°veis
            printf "REDIS_URL=redis://redis:6379/0\n" >> .env
            printf "NEXT_PUBLIC_API_URL=https://api.avaliasolar.com.br/api/v1\n" >> .env
            printf "CORS_ORIGINS=https://avaliasolar.com.br,https://www.avaliasolar.com.br\n" >> .env

            # Define permiss√µes seguras
            chmod 600 .env
            echo '‚úÖ Arquivo .env criado/atualizado com sucesso.'

      # üêã 2. Deploy e Inicializa√ß√£o (Build, Setup DB, Up)
      - name: Executar Build e Setup do Banco de Dados
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # AUMENTO DO TIMEOUT: Dando 40 minutos para o Docker Build/Instala√ß√£o de Gems
          timeout: 40m 
          script: |
            echo "--- 1. Puxando C√≥digo e Reconstruindo Imagens ---"
            cd ${{ env.PROJECT_PATH }}

            # Puxa as √∫ltimas altera√ß√µes do c√≥digo (incluindo o Company.rb corrigido)
            git pull origin main

            echo "--- 1.1 Validando vari√°veis do .env ---"
            if [ -f .env ]; then
              # L√™ vari√°veis para valida√ß√£o sem expor valores
              set -a; . ./.env; set +a
              MK_LEN=${#RAILS_MASTER_KEY}
              echo "RAILS_MASTER_KEY length: ${MK_LEN}"
              if [ -z "${RAILS_MASTER_KEY}" ] || [ ${MK_LEN} -lt 16 ]; then
                echo "‚ùå RAILS_MASTER_KEY inv√°lido ou ausente. Atualize o segredo no GitHub e reexecute." && exit 1
              fi
              if [ -z "${SECRET_KEY_BASE}" ]; then
                echo "‚ùå SECRET_KEY_BASE ausente. Configure no GitHub Secrets e reexecute." && exit 1
              fi
            else
              echo "‚ùå Arquivo .env n√£o encontrado em ${PWD}. Etapa anterior deve cri√°-lo." && exit 1
            fi

            # Reconstru√ß√£o das imagens (backend e frontend)
            docker-compose build --no-cache

            echo "--- 2. Setup do Banco de Dados (Cria√ß√£o e Migra√ß√£o) ---"
            
            # Derruba cont√™ineres e volumes antigos para garantir um estado limpo
            docker-compose down --volumes

            # Sobe a infraestrutura (DB, Redis, Frontend)
            docker-compose up -d db redis frontend

            # Aguarda o DB ficar pronto (Healthcheck ativo)
            echo "Aguardando PostgreSQL ficar pronto..."
            until docker-compose exec -T db pg_isready -U "$POSTGRES_USER" -d "$POSTGRES_DB" >/dev/null 2>&1; do
              sleep 2
            done

            echo "--- 2.1 Validando descriptografia de credentials ---"
            if ! docker-compose run --rm backend bundle exec rails credentials:show >/dev/null 2>&1; then
              echo "‚ùå Falha ao descriptografar credentials. Verifique RAILS_MASTER_KEY/SECRET_KEY_BASE." && exit 1
            fi

            # CRIA/MIGRA O BANCO DE DADOS E RODA SEEDS DE FORMA LIMPA:
            # Isso resolve o problema de estado inconsistente (DuplicateColumn)
            docker-compose run --rm backend bundle exec rake db:create db:migrate db:seed

            echo "--- 3. Subindo o Backend Final ---"
            # Inicia o cont√™iner principal do backend
            docker-compose up -d backend
            
            echo "--- 3.1 Precompilando assets do ActiveAdmin ---"
            # Limpa assets antigos e compila novamente
            docker exec ab0-backend rm -rf public/assets/* 2>/dev/null || true
            docker exec ab0-backend bundle exec rails assets:precompile RAILS_ENV=production || { echo "‚ùå Falha na precompila√ß√£o de assets"; exit 1; }
            ASSET_COUNT=$(docker exec ab0-backend sh -lc 'ls -1 public/assets 2>/dev/null | wc -l')
            echo "Assets compilados: ${ASSET_COUNT} arquivos"
            if [ "${ASSET_COUNT}" = "0" ]; then
              echo "‚ùå Nenhum asset encontrado em public/assets"; exit 1
            fi
            
            echo "‚úÖ DEPLOY CONCLU√çDO COM SUCESSO!"
            docker-compose ps
